<beast version='2.0'
       namespace='beast.app.beauti:beast.core:beast.evolution.branchratemodel:beast.evolution.speciation:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.likelihood:beast.evolution:beast.math.distributions'>

<!--        hidePanels='TAXON_SETS_PANEL,TIP_DATES_PANEL,PRIORS_PANEL,OPERATORS_PANEL'-->
    <beauticonfig spec='beast.app.beauti.BeautiConfig'
        inputLabelMap='beast.core.MCMC.operator=Operators,
	        beast.core.MCMC.logger=Loggers'
        inlinePlugins ='beast.core.MCMC.distribution,
            beast.evolution.sitemodel.SiteModel.substModel,
            beast.evolution.tree.coalescent.ExponentialGrowth,
            beast.evolution.tree.coalescent.ConstantPopulation,
            beast.evolution.tree.coalescent.Coalescent,
            beast.core.State.stateNode'
        collapsedPlugins ='beast.core.MCMC.logger'
        suppressPlugins = 'beast.core.MCMC.operator,
	        beast.evolution.tree.coalescent.Coalescent.treeIntervals,
	        beast.evolution.tree.coalescent.Coalescent.tree,
	        beast.core.MCMC.state,
	        beast.core.MCMC.distribution,
	        beast.core.MCMC.init,
	        beast.evolution.speciation.BirthDeathGernhard08Model.relativeDeathRate,
	        beast.evolution.speciation.BirthDeathGernhard08Model.treeIntervals,
	        beast.evolution.speciation.BirthDeathGernhard08Model.type,
	        beast.evolution.speciation.BirthDeathGernhard08Model.sampleProbability,
	        beast.evolution.speciation.BirthDeathGernhard08Model.tree,
	        beast.evolution.tree.Tree.trait,
	        beast.util.TreeParser.initial,
	        beast.util.TreeParser.taxa,
	        beast.util.TreeParser.trait,
	        beast.util.TreeParser.estimate,
	        beast.util.ClusterTree.initial,
	        beast.util.ClusterTree.taxa,
	        beast.util.ClusterTree.trait,
	        beast.util.ClusterTree.estimate,
	        beast.evolution.substitutionmodel.WAG.rates,
	        beast.evolution.substitutionmodel.WAG.frequencies,
	        beast.core.Operator.weight,
            beast.math.distributions.Prior.x,
            beast.math.distributions.MRCAPrior.tree,
            beast.math.distributions.MRCAPrior.monophyletic,
            beast.math.distributions.MRCAPrior.taxonset
            '
        buttonLabelMap='beast.app.beauti.BeautiInitDlg.&gt;&gt; details=Edit parameters'
    >

        <panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Data" tiptext="Aligned sequence data"
            path='distribution/distribution[id="likelihood"]/distribution'
            hasPartitions="false" icon='0.png' forceExpansion='FALSE'
            type='beast.evolution.likelihood.TreeLikelihood'
        />
<!--
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Taxon sets" tiptext="Taxon sets" 
            path='distribution/distribution[id="prior"]/distribution[type="beast.math.distributions.MRCAPrior"]'
            hasPartitions="false" icon='1.png' forceExpansion='FALSE'
            isVisible='true'
        />
-->
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Tip Dates" tiptext="Allows to specify data that a taxan was sampled"
            path='distribution/distribution[id="likelihood"]/distribution/tree/trait'
            hasPartitions="true" icon='2.png' forceExpansion='TRUE'
            isVisible='true'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Site Model" tiptext="Site model and substitution model specifications"
            path='distribution/distribution[id="likelihood"]/distribution/siteModel'
            hasPartitions="true" icon='3.png' forceExpansion='TRUE'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Clock Model" tiptext="Clock model"
            path='distribution/distribution[id="likelihood"]/distribution/branchRateModel'
            hasPartitions="true" icon='4.png' forceExpansion='TRUE'
        />
<!--
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Tree prior" tiptext="Tree prior"
            path='distribution/distribution[id="prior"]/distribution[type="Tree"]'
            hasPartitions="false" icon='5.png' forceExpansion='TRUE'
        />
-->
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Initialization" tiptext="Initial state"
            path='state/stateNode'
            hasPartitions="false" icon='6.png' forceExpansion='TRUE_START_COLLAPSED'
            isVisible='false'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Priors" tiptext="Other priors"
            path='distribution/distribution[id="prior"]/distribution'
            hasPartitions="false" icon='7.png' forceExpansion='TRUE_START_COLLAPSED'
            type='beast.core.Distribution'
        />

<!--
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="MRCA Priors" tiptext="Priors over internal nodes in a tree"
            path='distribution/distribution[id="prior"]/distribution[type=beast.math.distributions.MRCAPrior]'
            hasPartitions="false" icon='2.png' forceExpansion='TRUE_START_COLLAPSED'
            type='beast.core.Distribution'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Priors" tiptext="Other priors"
            path='distribution/distribution[id="prior"]/distribution[type!=beast.math.distributions.MRCAPrior]'
            hasPartitions="false" icon='7.png' forceExpansion='TRUE_START_COLLAPSED'
            type='beast.core.Distribution'
        />
-->
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Operators" tiptext="MCMC Operator details"
            path='operator'
            hasPartitions="false" icon='8.png' forceExpansion='TRUE_START_COLLAPSED'
            isVisible='false'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="MCMC" tiptext="MCMC parameters"
            path=''
            hasPartitions="false" icon='9.png' forceExpansion='TRUE'
        />

        <constraint spec='beast.app.beauti.InputConstraint' inputname='tree'>
            <plate var='n' range='#alignments'><plugin idref='$(n).treeLikelihood'/> </plate>
            <plate var='n' range='#alignments'><candidate idref='$(n).tree'/> </plate>
        </constraint>

        <plate var='n' range='#alignments'>
            <constraint spec='beast.app.beauti.InputConstraint' inputname='frequencies'>
                <plugin idref='$(n).freqs'/> 
                <candidate idref='$(n).freqParameter'/>
            </constraint>
            <constraint spec='beast.app.beauti.InputConstraint' inputname='data'>
                <plugin idref='$(n).freqs'/> 
                <candidate idref='$(n)'/>
            </constraint>
        </plate>
    </beauticonfig>

<!--
done: scaler parameter/tree entry should be <none>
done: better parameter editor
done: handle StateNode estimate flag
done: substitution model: make datatype safe
done: SiteModelInputEditor that does implement enable gamma shape only if gamma categories >= 2
done: operator editor, with weights
done: default subst model for amino acids in standard template
done: WAG prevent inputs
done: save/load unused part of templates
done: support partial templates (subst.model, site.model templates)
done: state scrubbing?
done: custom panels

TODO: Beauti user testing
TODO: Beauti/Genious integration
TODO: integration test - verify same outcomes as Beast 1 + set up Hudson for periodic integration tests
TODO: post processing: tracer, tree log analyser (already in Snap)?

done: spacing out of inputs
done: size of list of partitions
done: proper refreshs for multi partition sitemodel

TODO: sequence inspector
done: coalescent tree as initial tree - with taxa constraints
TODO: trait editor: guess button and clear button
TODO: initialisers, prior, posterior

done: tree prior: select from tree priors instead of having a list?
done: trait editor
done: prior editor with dynamic graphs of prior distribution
done: Data panel: remove delete button
done: Data panel: only allow selection of trees that are not initialisers


-->


    <data id="#alignments"></data>


    <plate var='n' range='#alignments'>
        <mergepoint id='substitutionmodel'/>
        <mergepoint id='clockmodel'/>

        <!-- The HKY substitution model (Hasegawa, Kishino & Yano, 1985)             -->
        <input spec='HKY' id='$(n).hky'>
            <kappa idref='$(n).hky.kappa'/>
            <frequencies id='$(n).freqs' spec='Frequencies'>
                <!--data idref='$(n)'/-->
                <frequencies id='$(n).freqParameter' spec='parameter.RealParameter' dimension='4' value='0.25'/>
            </frequencies>
        </input>

        <!-- The WAG empirical amino acidmodel  -->
        <!--input spec='WAG' id='$(n).WAG'/-->


        <input spec='TwoStateCovarion' id='$(n).TwoStateCovarion' alpha='0.1' switchingParameter='0.01' frequencies="@$(n).freqs"/>

        <!-- site model                                                              -->
        <input spec='SiteModel' id="$(n).siteModel" gammaCategoryCount='0'>
            <substModel idref='$(n).hky'/>
            <proportionInvariant idref='$(n).proportionInvariant'/>
            <mutationRate        idref='$(n).mutationRate'/>
            <shape               idref='$(n).gammaShape'/>
        </input>

        <input spec='TreeLikelihood' id="$(n).treeLikelihood">
            <data idref="$(n)"/>
            <tree idref="$(n).tree"/>
            <siteModel idref="$(n).siteModel"/>
            <branchRateModel spec='StrictClockModel' id='$(n).StrictClockModel'>
                <clock.rate id='$(n).clockRate' spec='parameter.RealParameter' value='1.0' estimate='false'/>
            </branchRateModel>
        </input>

        <parameter id="$(n).hky.kappa" value="1.0" lower="0.0" estimate='true'/>

        <tree spec='beast.evolution.tree.Tree' id='$(n).tree' initial='@$(n).RandomTree'>
	        <trait id='$(n).datetrait' spec='beast.evolution.tree.TraitSet' traitname='date' units='year'
		        value=''>
		        <taxa idref='$(n)'/>
	        </trait>
        </tree>
        <tree spec='beast.util.ClusterTree' id='$(n).upgmatree' clusterType='upgma' estimate='false'  trait='@$(n).datetrait' taxa='@$(n)'/>
        <tree spec='beast.util.TreeParser' id='$(n).Newicktree' estimate='false'  trait='@$(n).datetrait'  taxa='@$(n)' newick=""/>
        <tree spec='beast.evolution.tree.RandomTree' id='$(n).RandomTree' populationModel='@$(n).ConstantPopulation'  estimate='false' trait='@$(n).datetrait'  taxa='@$(n)'/>
    </plate>





    <distr id="normal" offset="0.0" spec="beast.math.distributions.Normal">
        <parameter name='mean' value='0'/>
        <parameter name='sigma' value='1'/>
    </distr>




    <run spec="MCMC" id="mcmc" chainLength="10000000">
        <state storeEvery='100000'>
            <plate var='n' range='#alignments'>
                <stateNode idref="$(n).hky.kappa"/>
                <stateNode idref="$(n).tree"/>
        		<stateNode idref="$(n).birthRate"/>
        		<stateNode idref="$(n).growthRate"/>
                <stateNode idref='$(n).rateCategories'/>
                <stateNode id='$(n).proportionInvariant' spec='parameter.RealParameter' value='0.0' lower='0.0' upper='1.0' estimate='false'/>
                <stateNode id='$(n).mutationRate' spec='parameter.RealParameter' value='1.0' estimate='false'/>
                <stateNode id='$(n).gammaShape' spec='parameter.RealParameter' value='1.0' estimate='false'/>
            </plate>
        </state>

        <distribution spec="CompoundDistribution" id="posterior">
            <distribution spec="CompoundDistribution" id="prior">
                <plate var='n' range='#alignments'>
                    <distribution id="$(n).coalescent" spec="Coalescent">
                        <treeIntervals spec='TreeIntervals' id='$(n).TreeIntervals'>
                             <tree idref="$(n).tree"/>
                        </treeIntervals>
                        <populationModel spec="ConstantPopulation" id='$(n).ConstantPopulation' popSize='@$(n).popSize'/>
                    </distribution>
                    <distribution id='$(n).kappa.prior' spec='Prior' x='@$(n).hky.kappa'>
                        <distr spec="OneOnX"/>
                    </distribution>
                    <mergepoint id='priors'/>
                </plate>
            </distribution>
            <distribution spec="CompoundDistribution" id="likelihood">
                <plate var='n' range='#alignments'>
                    <distribution id='$(n).likelihood_' idref="$(n).treeLikelihood"/>
                </plate>
            </distribution>
        </distribution>
    
        <plate var='n' range='#alignments'>
            <mergepoint id='operators'/>
            <operator id='$(n).kappaScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1" parameter="@$(n).hky.kappa"/>
            <operator id='$(n).proportionInvariantScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1" parameter="@$(n).proportionInvariant"/>
            <operator id='$(n).mutationRateScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1" parameter="@$(n).mutationRate"/>
            <operator id='$(n).gammaShapeScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1" parameter="@$(n).gammaShape"/>
<!--
            <operator id='$(n).clockRateScaler' spec='ScaleOperator' scaleAll='false' scaleFactor="0.5" weight="1" parameter="@$(n).clockrates"/>
	        <operator id='$(n).birthRateScaler' spec='ScaleOperator' scaleFactor="0.75" weight="3" parameter='@$(n).birthRate'/>
	        <operator id='$(n).growthRatecaler' spec='ScaleOperator' scaleFactor="0.75" weight="3" parameter='@$(n).growthRate'/>
            <operator id="$(n).categoriesRandomWalk" spec="IntUniformOperator" weight="1" parameter="@$(n).rateCategories"/>
-->


            <operator id='$(n).FrequenciesExchanger' spec='DeltaExchangeOperator' delta="0.01" weight="0.1" parameter="@$(n).freqParameter"/>

            <operator id='$(n).treeScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1" tree="@$(n).tree"/>
            <operator spec='Uniform' weight="10" tree="@$(n).tree"/>
            <operator spec='SubtreeSlide' weight="5" gaussian="true" size="1.0" tree="@$(n).tree"/>
            <operator id='$(n).narrow' spec='Exchange' isNarrow='true' weight="1" tree="@$(n).tree"/>
            <operator id='$(n).wide' spec='Exchange' isNarrow='false' weight="1" tree="@$(n).tree"/>
            <operator spec='WilsonBalding' weight="1" tree="@$(n).tree"/>
        </plate>

        <logger id='tracelog' logEvery="10000" fileName="beast_$(seed).log">
	        <model idref='posterior'/>
            <log idref="likelihood"/>
            <plate var='n' range='#alignments'>
                <log idref='$(n).hky.kappa'/>
                <log spec='beast.evolution.tree.TreeHeightLogger' tree='@$(n).tree'/>
                <log idref="$(n).freqParameter"/>
            </plate>
        </logger>
        <plate var='n' range='#alignments'>
            <logger id='$(n).treelog' logEvery="10000" fileName="beast_$(n).$(seed).trees">
                <log idref="$(n).tree"/>
            </logger>
        </plate>
        <logger id='screenlog' logEvery="10000">
	        <model idref='posterior'/>
            <log idref="likelihood"/>
      	    <ESS spec='ESS' name='log' arg="@likelihood"/>
            <plate var='n' range='#alignments'>
                <log idref='$(n).hky.kappa'/>
    	    <ESS spec='ESS' name='log' arg="@$(n).hky.kappa"/>
            </plate>
        </logger>
    </run>

</beast>

